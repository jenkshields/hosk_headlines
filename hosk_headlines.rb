require 'marky_markov'
require 'tempfile'
require 'rubygems'
require 'bundler/setup'
require 'mastodon'

client = Mastodon::REST::Client.new(base_url: "https://botsin.space", bearer_token: "811587e8f09d91b6d217f1ff04693f13639a6fe588d5e07f6340f3170ce6fefb")


#take the CSV generated by the scraper and strip any comma not surrounded by whitespace
#also strip quotation marks

def file_edit(filename, regexp, replacement)
  Tempfile.open(".#{File.basename(filename)}", File.dirname(filename)) do |tempfile|
    File.open(filename).each do |line|
      tempfile.puts line.gsub(regexp, replacement)
    end
    tempfile.fdatasync
    tempfile.close
    stat = File.stat(filename)
    FileUtils.chown stat.uid, stat.gid, tempfile.path
    FileUtils.chmod stat.mode, tempfile.path
    FileUtils.mv tempfile.path, filename
  end
end

file_edit('headlines.txt', "\"", '')
file_edit('headlines.txt', /(,(?=\S)|:)/, ' ')
file_edit('headlines.txt', "Hosking", '')

file_edit('blurbs.txt', /(,(?=\S)|:)/, ' ')
file_edit('blurbs.txt', "\"", '')
file_edit('blurbs.txt', 'COMMENT:', '')
file_edit('blurbs.txt', 'COMMENT', '')

def tooter(client)
  headline_markov = MarkyMarkov::TemporaryDictionary.new
  headline_markov.parse_file "headlines.txt"
  headline = "Hosking: #{headline_markov.generate_n_words rand(5..10)}"
  

  blurb_markov = MarkyMarkov::TemporaryDictionary.new
  blurb_markov.parse_file "blurbs.txt"
  blurb = "COMMENT: #{blurb_markov.generate_n_sentences 2}"

  article = headline + "\n" + blurb

  client.create_status(article)
  puts "tooted: #{article}"

  headline_markov.clear!
  blurb_markov.clear!
end

while true
  tooter(client)
  puts "sleeping..."
  sleep(3600)
end